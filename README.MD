# Oracle Backup Automation

Este proyecto es un **script en Python** para automatizar la exportaciÃ³n de esquemas de bases de datos Oracle usando `expdp` (Data Pump), comprimir los resultados en un archivo 7z, subirlos a un servidor remoto mediante SFTP y enviar un correo con el registro del proceso.

El objetivo es **simplificar las copias de seguridad automatizadas** de Oracle y su gestiÃ³n remota.

---

## CaracterÃ­sticas

- Exporta esquemas de Oracle usando `expdp` o `exp`.
- Genera logs detallados de la operaciÃ³n.
- ComprensiÃ³n de archivos `.dmp` y logs en un archivo `.7z`.
- ProtecciÃ³n opcional del archivo comprimido con contraseÃ±a.
- Transferencia automÃ¡tica a un servidor SFTP remoto.
- Limpieza de archivos antiguos tanto localmente como en el servidor remoto.
- NotificaciÃ³n por correo electrÃ³nico con resultados del backup, incluyendo advertencias o errores.
- Configurable mediante archivos JSON externos.

---

## Requisitos

- Python 3.8+
- Cliente Oracle (`expdp` o `exp`) configurado y accesible en PATH.
- 7-Zip instalado y accesible en PATH.
- cx_oracle (para realizar consultas ORACLE)
- LibrerÃ­as Python requeridas (instalables vÃ­a `pip`):

```bash
pip install paramiko py7zr cx_oracle
```

## Estructura de proyecto
```
project/
â”‚
â”œâ”€ main.py                 # Script principal de ejecuciÃ³n
â”œâ”€ config/
â”‚  â”œâ”€ config.json          # ConfiguraciÃ³n general del backup
â”‚  â””â”€ credenciales.json    # Credenciales para BBDD, SFTP y correo
â”œâ”€ log/                    # Carpeta donde se generan los logs
â””â”€ lib/                    # LibrerÃ­as internas del proyecto
   â”œâ”€ lug_ficheros.py
   â”œâ”€ lug_log.py
   â”œâ”€ lug_exe.py
   â”œâ”€ lug_zip.py
   â”œâ”€ lug_sftp.py
   â”œâ”€ lug_correo.py
   â””â”€ lug_bbdd.py
```

## ConfiguraciÃ³n

### config.json

```
{
    "FicheroCredenciales" : "config/credenciales.json",    
    "SQLRutaBackup" : "SELECT DIRECTORY_PATH FROM dba_directories WHERE DIRECTORY_NAME = 'DATA_PUMP_DIR';",
    "FraseAdvertencias" : "advertencias",
    "FraseError" : "no ha terminado correctamente",
    "Backup" :[ 
        {
            "Comando" : "expdp",
            "Esquema" : "ESQUEMA_BBDD",
            "Password" : "ContraseÃ±aCifrado", 
            "FicheroBackup" : "backups/%%ESQUEMA%%-%%FECHA%%.dmp",
            "FicheroLog" : "backups/%%ESQUEMA%%-%%FECHA%%.log",
            "FicheroComprimido" : "%%ESQUEMA%%-%%FECHA%%.7z"    
        }
    ],
    "ConfiguracionSFTP" : {
        "RutaInicialSFTP" : "/RUTA_RELATIVA_REMOTA",
        "RutaSFTP" : "BackupTraza",
        "NumeroBackupsaMantener" : 5
    },
    "AvisoCorreo" : {
        "Destinatario" : "it@dominio.com",
        "Asunto" : "Proceso de backup del servidor %%SERVIDOR%% de la base de datos %%BBDD%%",
        "Mensaje" : "<p>Revisar log y ruta del proceso de backup con estos datos.</p>"
    }
}
```

### credenciales.json
```
{
    "BBDD" : [
        "SERVIDOR_BBDD",
        1521,
        "BBDD(SID)",
        "USER_BBDD",
        "PASS_USER_BBDD"
    ],
   
    "CORREO" : [
        "usuario_envio@dominio.com",
        "smtp.serviciodecorreo.es",
        465,
        "usuario_envio@dominio.com",
        "PASSUserCorreo"
    ],
    "SFTP" : [
        "servidor_sftp",
        2222,
        "user_SFTP",
        "pass_sftp",
        "",
        ""    
    ]
}
```
## Uso

Ejecutar el script principal:

```
python main.py
```

El script realizarÃ¡ los siguientes pasos automÃ¡ticamente:

* Lee la configuraciÃ³n y credenciales.
* Ejecuta expdp para cada esquema definido (revisar config.json).
* Verifica errores y advertencias en los logs generados.
* Comprime los resultados en un archivo .7z (con o sin contraseÃ±a).
* Sube el archivo al servidor SFTP.
* Purga archivos antiguos en SFTP y localmente segÃºn configuraciÃ³n.
* EnvÃ­a un correo con el log y los detalles del backup.

## Logs

Los logs se generan en la carpeta log/ con un timestamp en el nombre:

```
log/20250922123045001.log

```

Cada log incluye:

* Comando ejecutado
* Resultado del backup
* Tiempo total de ejecuciÃ³n
* Advertencias o errores encontrados

## Automatizar

Se debe de crear una tarea programada para ejecutar este programa.

Observar que si ejecutamos expdp necesitamos tener acceso a la carpeta donde guarda el backup Oracle para poder enviarlo a remoto.

Si no se puede ejecutar expdp porque el servidor no expone esa carpeta se pued ejecutar exp

Lo normal es ejecutarlo en la mÃ¡quina servidor, asÃ­ garantizamos que este programa tenga acceso al fichero que se genere.

## Flujo

```mermaid
flowchart TD

A[Inicio del script] --> B[Cargar config y credenciales]
B -->|OK| C[Inicializar log de ejecucion]
B -->|Error| Z[Mostrar error y finalizar]

C --> D[Iterar por cada esquema]
D --> E[Construir comando exp/expdp]
E --> F[Ejecutar comando de exportacion]

F -->|Exito| G[Revisar logs de Oracle]
F -->|Error| Y[Registrar error en log]

G --> H{Hay advertencias o errores?}
H -->|Si| I[Marcar advertencia/error]
H -->|No| J[Continuar]

J --> K[Comprimir ficheros a 7z]
K --> L[Subir backup a SFTP]

L -->|Exito| M[Eliminar ficheros locales]
L -->|Error| Y

M --> N{Mas de N backups en SFTP?}
N -->|Si| O[Purgar backups antiguos]
N -->|No| P[Continuar]

O --> P
P --> Q[Calcular tiempo de ejecucion]

Q --> R[Enviar correo con log y estado]
R --> S[Fin del proceso]

Y --> Q
Z --> S

    
```

---

ðŸ”Ž Este diagrama refleja:  
- Los **puntos de decisiÃ³n** (configuraciÃ³n vÃ¡lida, advertencias, errores, nÃºmero de backups).  
- El **flujo principal**: configuraciÃ³n â†’ backup â†’ log â†’ compresiÃ³n â†’ SFTP â†’ limpieza â†’ correo.  
- Los **flujos de error/advertencia** integrados en el proceso.  

---

